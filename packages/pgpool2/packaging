#!/bin/bash
set -eu

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
 # Available variables
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package
export HOME=/var/vcap


# see http://www.pgpool.net/download.php?f=pgpool-II-3.5.0.tar.gz
VERSION=3.7.4

tar -xzf pgpool2/pgpool-II-${VERSION}.tar.gz
cd pgpool-II-${VERSION}/
# patch it up, since there isn't much in the way of configure options....
patch -p1 <<EOF
diff --git a/src/include/parser/pg_config_manual.h b/src/include/parser/pg_config_manual.h
index bac8023e..0689d085 100644
--- a/src/include/parser/pg_config_manual.h
+++ b/src/include/parser/pg_config_manual.h
@@ -208,7 +208,7 @@
  * here's where to twiddle it.  You can also override this at runtime
  * with the postmaster's -k switch.
  */
-#define DEFAULT_PGSOCKET_DIR  "/tmp"
+#define DEFAULT_PGSOCKET_DIR "/var/vcap/sys/run/postgres"
 
 /*
  * This is the default event source for Windows event log.
diff --git a/src/include/pcp/pcp_stream.h b/src/include/pcp/pcp_stream.h
index 254b98cb..52df6ce1 100644
--- a/src/include/pcp/pcp_stream.h
+++ b/src/include/pcp/pcp_stream.h
@@ -48,6 +48,6 @@ extern int pcp_read(PCP_CONNECTION *pc, void *buf, int len);
 extern int pcp_write(PCP_CONNECTION *pc, void *buf, int len);
 extern int pcp_flush(PCP_CONNECTION *pc);
 
-#define UNIX_DOMAIN_PATH "/tmp"
+#define UNIX_DOMAIN_PATH "/var/vcap/sys/run/pgpool"
 
 #endif /* PCP_STREAM_H */
diff --git a/src/include/pool.h b/src/include/pool.h
index f87995cd..dcf74aa0 100644
--- a/src/include/pool.h
+++ b/src/include/pool.h
@@ -72,16 +72,16 @@
 #define HBA_CONF_FILE_NAME "pool_hba.conf"
 
 /* pid file directory */
-#define DEFAULT_LOGDIR "/tmp"
+#define DEFAULT_LOGDIR "/var/vcap/sys/log/pgpool"
 
 /* Unix domain socket directory */
-#define DEFAULT_SOCKET_DIR "/tmp"
+#define DEFAULT_SOCKET_DIR "/var/vcap/sys/run/pgpool"
 
 /* Unix domain socket directory for watchdog IPC */
-#define DEFAULT_WD_IPC_SOCKET_DIR "/tmp"
+#define DEFAULT_WD_IPC_SOCKET_DIR "/var/vcap/sys/run/pgpool"
 
 /* pid file name */
-#define DEFAULT_PID_FILE_NAME "/var/run/pgpool/pgpool.pid"
+#define DEFAULT_PID_FILE_NAME "/var/vcap/sys/run/pgpool/pgpool.pid"
 
 /* status file name */
 #define STATUS_FILE_NAME "pgpool_status"

EOF
./configure --prefix ${BOSH_INSTALL_TARGET} --with-pgsql=/var/vcap/packages/postgres
make
make install
