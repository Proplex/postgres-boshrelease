#!/bin/bash
set -xeu

KEY="<%= p('pgpool.ssh_key') %>"
PUB=$(ssh-keygen -yf /dev/stdin <<<"$KEY")

if [ ! -f /home/vcap/.ssh/authorized_keys ]; then
    mkdir -p /home/vcap/.ssh/
    touch /home/vcap/.ssh/authorized_keys
fi

if $(cat /home/vcap/.ssh/authorized_keys | grep "$PUB" || false); then
  echo "We've already deployed"
else
  echo "Adding SSH key to auth_key"
  cd /home/vcap/.ssh/
  echo "$PUB" >> authorized_keys
  chmod 700  /home/vcap/.ssh/
  chmod 600  /home/vcap/.ssh/authorized_keys
  chown -R vcap:vcap /home/vcap/.ssh/
  cd /var/vcap/store/postgres
  echo "$KEY" > id_rsa
  chmod 600 id_rsa
  echo "$PUB" > id_rsa.pub
  chmod 600 id_rsa.pub
  chown -R vcap:vcap /var/vcap/store/postgres/id_rsa*
  exit 0;
fi