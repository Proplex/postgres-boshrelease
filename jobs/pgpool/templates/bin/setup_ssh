#!/bin/bash
set -xeu

KEY="<%= p('pgpool.ssh_key') %>"
PUB=$(ssh-keygen -yf /dev/stdin <<<"$KEY")

# archive directory for postgres WAL archives
if [ ! -f /var/vcap/store/postgres/archive ]; then
  mkdir -p /var/vcap/store/postgres/archive
  chmod 755 /var/vcap/store/postgres/archive
  chown -R vcap:vcap /var/vcap/store/postgres/archive
fi


if [ ! -f /home/vcap/.ssh/authorized_keys ]; then
    mkdir -p /home/vcap/.ssh/
    touch /home/vcap/.ssh/authorized_keys
fi

if $(cat /home/vcap/.ssh/authorized_keys | grep "$PUB" || false); then
  echo "We've already deployed"
  exit 0;
else
  echo "vcap    ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/postgres_vcap_sudo
  echo "Adding SSH key to auth_key"
  cd /home/vcap/.ssh/
  echo "$PUB" >> authorized_keys
  echo "StrictHostKeyChecking=no" > /home/vcap/.ssh/config
  chmod 700  /home/vcap/.ssh/
  chmod 600  /home/vcap/.ssh/authorized_keys 
  chmod 600 /home/vcap/.ssh/config
  chown -R vcap:vcap /home/vcap/.ssh/
  cd /var/vcap/store/postgres
  echo "$KEY" > id_rsa
  chmod 600 id_rsa
  echo "$PUB" > id_rsa.pub
  chmod 600 id_rsa.pub
  chown -R vcap:vcap /var/vcap/store/postgres/id_rsa*
  exit 0;
fi
